# ЛР02 — Kubernetes: базовый деплой (stateless)

План

- Обзор Deployment, Service, Ingress, probes, requests/limits, стратегия обновлений.
- Практика: деплой stateless‑приложения, проверка доступности, rolling update без простоя.
- Параметризация манифестов (namespace, имя, порт, ресурсы, ingressClass).
- Варианты (24) для дифференциации параметров.
- Материалы для чтения и отладка.

## Необходимые знания и ПО

- Доступ к кластеру Kubernetes (minikube/kind/k3d или managed), установлен `kubectl`.
- Образ вашего приложения из ЛР01, опубликованный в Docker Hub или GHCR.

## Краткая теория

- Deployment — контроллер для stateless pod’ов, управляет ReplicaSet и стратегией обновлений (по умолчанию RollingUpdate: `maxUnavailable`/`maxSurge`).
- Service (ClusterIP) — стабильная точка доступа к pod’ам по селекторам; Ingress — внешний доступ по HTTP(S) через контроллер (например, NGINX Ingress Controller).
- Probes — `liveness`/`readiness`/`startup`, позволяют перезапускать «зависшие» pod’ы и исключать их из трафика.
- Requests/Limits — гарантии и верхние границы ресурсов для планировщика.

## Практика

1. Подготовьте реестр

   - Убедитесь, что образ из ЛР01 доступен: `<registry>/<user>/<image>:<tag>`.

2. Создайте Namespace и базовые манифесты

   - `namespace.yaml`

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: app01
```

- `deployment.yaml` (2+ реплики, probes, ресурсы)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web01
  namespace: app01
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web01
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: web01
    spec:
      containers:
        - name: web
          image: <registry>/<user>/<image>:<tag>
          ports:
            - containerPort: 8080
          env:
            - name: APP_ENV
              value: prod
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /live
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          resources:
            requests:
              cpu: "150m"
              memory: "128Mi"
            limits:
              cpu: "300m"
              memory: "256Mi"
```

- `service.yaml` (ClusterIP)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web01
  namespace: app01
spec:
  selector:
    app: web01
  ports:
    - port: 80
      targetPort: 8080
```

- `ingress.yaml` (nginx ingress)

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web01
  namespace: app01
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    - host: web01.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web01
                port:
                  number: 80
```

3. Деплой и проверка

- Примените манифесты, проверьте Pods/Service/Ingress; выполните `curl` к хосту.

4. Rolling update

- Обновите тег образа — убедитесь, что pod’ы заменяются плавно без простоя.

5. Параметризация

- Допустимы: `kustomize` overlays или Helm (values: `namespace`, `name`, `replicas`, `port`, `resources`, `ingressClass`).

## Быстрый старт

Минимальные шаги на `minikube` (проверка базового деплоя):

1. Запустите кластер: `minikube start`
1. Включите ingress контроллер: `minikube addons enable ingress`
1. Примените все манифесты: `kubectl apply -f ./k8s/`
1. Узнайте IP: `minikube ip`; добавьте строку `<ip> web01.local` в `hosts`
1. Проверьте доступность: `curl -I http://web01.local/`
1. Выполните rolling update: измените тег образа и снова `kubectl apply -f deployment.yaml`; наблюдайте замену Pod без простоя (`kubectl get pods -w`)

## Критерии приёмки

- Приложение доступно через Ingress по HTTP, работают `readiness`/`liveness`, заданы `requests`/`limits`, rolling update выполнен без простоя (лог/скриншоты).
- Манифесты валидны и параметризуемы. Репозиторий содержит README с шагами запуска и проверок.

## Формат сдачи

- PR в основную ветку; назначить ревьювером `https://github.com/andreiNiasiuk`. В README: цели, шаги деплоя, параметры, артефакты/скриншоты.

См. варианты в файле `Варианты.md`.

## Материалы для чтения

- Kubernetes Docs: Deployments, Services, Ingress
  - https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
  - https://kubernetes.io/docs/concepts/services-networking/service/
  - https://kubernetes.io/docs/concepts/services-networking/ingress/
- Probes: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/

## Отладка и типичные ошибки

- Ingress не работает: проверьте установлен ли контроллер (`minikube addons enable ingress`), корректен ли host и DNS/hosts.
- Pod не готов: проверьте `readinessProbe`, логи контейнера и события (`kubectl describe pod ...`).
- Обновление «ломает» трафик: установите `maxUnavailable: 0` и `readinessProbe`, чтобы исключить нездоровые pod’ы из обслуживания.
